@model ProjetDotNet.Models.Projet
@using ProjetDotNet.Helpers
@inject ProjetDotNet.Data.AppDbContext _db
@{
    ViewBag.Title = "Détails du projet";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var projectId = Model.ProjectID;

    // droits courants : seul SiteAdmin ou Project Admin peut modifier
    var current = AuthorizationHelper.GetCurrentUserId(User, _db);
    var canEditProject = AuthorizationHelper.IsSiteAdmin(_db, current) || AuthorizationHelper.IsProjectAdmin(_db, current, Model.ProjectID);

    var canAddProjectMember = AuthorizationHelper.CanAddMembersToProject(_db, current, Model.ProjectID);

    // qui peut gérer les sprints pour ce projet (Admin ou ScrumMaster)
    var canManageSprints = AuthorizationHelper.IsSiteAdmin(_db, current) || AuthorizationHelper.CanCreateSprint(_db, current, Model.ProjectID);
}

<div class="max-w-6xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">@Model.Nom</h1>
            <p class="text-sm text-gray-500"> • Organisation: @(Model.Organisation?.Nom ?? "—")</p>
        </div>
        <div class="flex items-center space-x-2">
            @if (canEditProject)
            {
                <a asp-action="Edit" asp-route-id="@Model.ProjectID" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">
                    <i class="fas fa-edit mr-2"></i>Modifier
                </a>
            }
            <a asp-action="Index" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                Retour
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Détails</h2>
                <div class="text-sm text-gray-700 space-y-2">
                    <div><strong>Clé :</strong> @(Model.CleProjet ?? "-")</div>
                    <div><strong>Statut :</strong> @Model.Statut</div>
                    <div><strong>Dates :</strong> @(Model.DateDebut?.ToString("yyyy-MM-dd") ?? "—") → @(Model.DateFin?.ToString("yyyy-MM-dd") ?? "—")</div>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div><strong>Description :</strong> @Model.Description</div>
                    }
                </div>
            </div>

            <!-- Membres -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Membres (@(Model.Membres?.Count() ?? 0))</h3>
                    @if (canAddProjectMember)
                    {
                        <a asp-controller="MembreProjet" asp-action="Add" asp-route-projectId="@projectId" class="px-3 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Ajouter</a>
                    }
                </div>

                <div class="space-y-3">
                    @if (Model.Membres != null && Model.Membres.Any(m => m.Utilisateur != null))
                    {
                        foreach (var m in Model.Membres.Where(m => m.Utilisateur != null))
                        {
                            var name = m.Utilisateur?.Nom ?? m.Utilisateur?.Email ?? "Utilisateur";
                            var initial = !string.IsNullOrEmpty(name) ? name.Substring(0, 1).ToUpper() : "?";
                            <div class="flex items-center justify-between p-3 rounded-lg border border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-semibold">
                                        @initial
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-800">@name</div>
                                        <div class="text-xs text-gray-500">@m.Utilisateur?.Email</div>
                                    </div>
                                    <div class="ml-4 px-2 py-1 text-xs rounded bg-gray-100 text-gray-700">
                                        @m.Role.ToString()
                                    </div>
                                </div>

                                <div class="flex items-center space-x-2">
                                    <a asp-controller="MembreProjet" asp-action="Edit"
                                       asp-route-projectId="@m.ProjectID" asp-route-userId="@m.UserID"
                                       class="px-3 py-1 text-sm text-teal-700 border border-teal-200 rounded hover:bg-teal-50">
                                        <i class="fas fa-user-edit mr-1"></i>Modifier
                                    </a>

                                    <form asp-controller="MembreProjet" asp-action="Delete" method="post" class="inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="projectId" value="@m.ProjectID" />
                                        <input type="hidden" name="userId" value="@m.UserID" />
                                        <button type="submit" class="px-3 py-1 text-sm text-red-600 border border-red-200 rounded hover:bg-red-50">
                                            <i class="fas fa-user-minus mr-1"></i>Retirer
                                        </button>
                                    </form>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-gray-500 italic">Aucun membre pour ce projet.</div>
                    }
                </div>
            </div>

            <!-- Sprints -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Sprints (@(Model.Sprints?.Count() ?? 0))</h3>
                    @if (canManageSprints)
                    {
                        <a asp-controller="Sprints" asp-action="Create" asp-route-projectId="@projectId" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Créer un sprint</a>
                    }
                </div>

                <div class="space-y-3">
                    @if (Model.Sprints != null && Model.Sprints.Any())
                    {
                        foreach (var s in Model.Sprints.OrderByDescending(sp => sp.DateDebut))
                        {
                            <div class="flex items-center justify-between p-3 rounded-lg border border-gray-100">
                                <div>
                                    <div class="font-medium text-gray-800">@s.Nom</div>
                                    <div class="text-xs text-gray-500">@s.DateDebut.ToString("yyyy-MM-dd") — @s.DateFin.ToString("yyyy-MM-dd")</div>
                                </div>

                                <div class="flex items-center space-x-2">
                                    <a asp-controller="Sprints" asp-action="Details" asp-route-id="@s.SprintID" class="px-3 py-1 text-sm text-gray-600 border rounded hover:bg-gray-50">Voir</a>

                                    @* Modifier / Supprimer visibles seulement pour Admin ou ScrumMaster *@
                                    @if (canManageSprints)
                                    {
                                        <a asp-controller="Sprints" asp-action="Edit" asp-route-id="@s.SprintID" class="px-3 py-1 text-sm text-teal-600 border rounded hover:bg-teal-50">Modifier</a>
                                        <a asp-controller="Sprints" asp-action="Delete" asp-route-id="@s.SprintID" class="px-3 py-1 text-sm text-red-600 border rounded hover:bg-red-50" onclick="return confirm('Supprimer ce sprint ?');">Supprimer</a>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-gray-500 italic">Aucun sprint pour ce projet.</div>
                    }
                </div>
            </div>

            <!-- Autres sections (tâches...) si nécessaire -->
        </div>

        <aside class="space-y-6">
            @* <div class="bg-white rounded-xl shadow p-6">
                <h4 class="font-semibold text-gray-800 mb-2">Résumé</h4>
                <div class="text-sm text-gray-600">
                    <div class="mb-2"><strong>ID :</strong> @Model.ProjectID</div>
                    <div class="mb-2"><strong>Membres :</strong> @(Model.Membres?.Count() ?? 0)</div>
                    <div class="mb-2"><strong>Date création :</strong> @Model.DateCreation.ToString("dd MMMM yyyy HH:mm")</div>
                </div>
            </div> *@

            @if (canEditProject)
            {
                <div class="bg-white rounded-xl shadow p-6">
                
                    <h4 class="font-semibold text-gray-800 mb-2">Actions</h4>
                    <div class="space-y-2">
                        <a asp-action="Edit" asp-route-id="@Model.ProjectID" class="block px-4 py-2 border rounded text-center hover:bg-gray-50">Modifier le projet</a>
                        <a asp-controller="MembreProjet" asp-action="Add" asp-route-projectId="@projectId" class="block px-4 py-2 bg-teal-600 text-white rounded text-center hover:bg-teal-700">Ajouter un membre</a>
                    </div>
                </div>
            }
        </aside>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}