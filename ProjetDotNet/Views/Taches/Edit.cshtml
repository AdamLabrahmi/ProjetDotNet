@model ProjetDotNet.Models.Tache
@using ProjetDotNet.Models.Enums
@{
    ViewBag.Title = "Modifier la tâche";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Modifier la tâche</h1>

    <form asp-action="Edit" method="post" class="bg-white p-6 rounded-xl shadow">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="TacheID" />
        <input type="hidden" asp-for="CreateurID" />

        <div asp-validation-summary="ModelOnly" class="text-sm text-red-600 mb-4"></div>

        <!-- 🔹 Titre -->
        <div class="mb-4">
            <label asp-for="Titre" class="block text-sm font-medium text-gray-700 mb-1">
                Titre de la tâche
            </label>
            <input asp-for="Titre" class="w-full border rounded px-3 py-2" />
            <span asp-validation-for="Titre" class="text-sm text-red-600"></span>
        </div>

        <!-- 🔹 Description -->
        <div class="mb-4">
            <label asp-for="Description" class="block text-sm font-medium text-gray-700 mb-1">
                Description détaillée
            </label>
            <textarea asp-for="Description" rows="4" class="w-full border rounded px-3 py-2"></textarea>
            <span asp-validation-for="Description" class="text-sm text-red-600"></span>
        </div>

        <!-- 🔹 Type / Priorité / Statut -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label asp-for="Type" class="block text-sm font-medium text-gray-700 mb-1">
                    Type de tâche
                </label>
                <select asp-for="Type" asp-items="ViewBag.Types" class="w-full border rounded px-3 py-2"></select>
            </div>

            <div>
                <label asp-for="Priorite" class="block text-sm font-medium text-gray-700 mb-1">
                    Priorité
                </label>
                <select asp-for="Priorite" asp-items="ViewBag.Priorites" class="w-full border rounded px-3 py-2"></select>
            </div>

            <div>
                <label asp-for="Statut" class="block text-sm font-medium text-gray-700 mb-1">
                    Statut actuel
                </label>
                <select asp-for="Statut" asp-items="ViewBag.Statuts" class="w-full border rounded px-3 py-2"></select>
            </div>
        </div>

        <!-- 🔹 Estimation / Temps restant -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label asp-for="EstimationDur" class="block text-sm font-medium text-gray-700 mb-1">
                    Estimation (heures)
                </label>
                <input asp-for="EstimationDur" type="number" step="0.1"
                       class="w-full border rounded px-3 py-2" />
            </div>

            <div>
                <label asp-for="TempsRestant" class="block text-sm font-medium text-gray-700 mb-1">
                    Temps restant (heures)
                </label>
                <input asp-for="TempsRestant" type="number" step="0.1"
                       class="w-full border rounded px-3 py-2" />
            </div>
        </div>

        <!-- 🔹 Projet -->
        <div class="mb-4">
            <label asp-for="ProjectID" class="block text-sm font-medium text-gray-700 mb-1">
                Projet associé
            </label>
            <select asp-for="ProjectID"
                    id="ProjectSelect"
                    asp-items="ViewBag.Projets"
                    class="w-full border rounded px-3 py-2">
            </select>
        </div>

        <!-- 🔹 Sprint / Équipe / Assigné -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Sprint
                </label>
                <select asp-for="SprintID" id="SprintSelect"
                        class="w-full border rounded px-3 py-2">
                    <option value="">-- Aucun --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Équipe
                </label>
                <select id="EquipeSelect"
                        class="w-full border rounded px-3 py-2">
                    <option value="">-- Choisir une équipe --</option>
                </select>
            </div>

            <div>
                <label asp-for="AssigneeID" class="block text-sm font-medium text-gray-700 mb-1">
                    Assigné à
                </label>
                <select asp-for="AssigneeID"
                        id="AssigneeSelect"
                        class="w-full border rounded px-3 py-2">
                    <option value="">-- Aucun --</option>
                </select>
            </div>
        </div>

        <!-- 🔹 Actions -->
        <div class="flex justify-end gap-2">
            <a asp-action="Index" class="px-4 py-2 border rounded">Annuler</a>
            <button type="submit" class="px-4 py-2 rounded bg-teal-600 text-white">
                Enregistrer les modifications
            </button>
        </div>
    </form>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        const projectSelect = document.getElementById("ProjectSelect");
        const sprintSelect = document.getElementById("SprintSelect");
        const equipeSelect = document.getElementById("EquipeSelect");
        const assigneeSelect = document.getElementById("AssigneeSelect");

        const selectedSprint = "@Model.SprintID";
        const selectedAssignee = "@Model.AssigneeID";

        function reset(select, text) {
            select.innerHTML = `<option value="">${text}</option>`;
            select.disabled = true;
        }

        async function loadSprints(projectId) {
            if (!projectId) { reset(sprintSelect, "-- Aucun --"); return; }
            reset(sprintSelect, "Chargement...");
            const res = await fetch(`/Taches/GetSprintsByProject?projectId=${projectId}`);
            const data = await res.json();
            sprintSelect.innerHTML = `<option value="">-- Aucun --</option>`;
            data.forEach(s => {
                sprintSelect.innerHTML += `<option value="${s.sprintID}" ${s.sprintID == selectedSprint ? "selected" : ""}>${s.nom}</option>`;
            });
            sprintSelect.disabled = false;
        }

        async function loadEquipes(projectId) {
            if (!projectId) { reset(equipeSelect, "-- Choisir équipe --"); return; }
            reset(equipeSelect, "Chargement...");
            const res = await fetch(`/Taches/GetEquipesByProjet?projectId=${projectId}`);
            const data = await res.json();
            equipeSelect.innerHTML = `<option value="">-- Choisir équipe --</option>`;
            data.forEach(e => {
                equipeSelect.innerHTML += `<option value="${e.teamID}">${e.nom}</option>`;
            });
            equipeSelect.disabled = false;
        }

        // Charge les membres en excluant ScrumMaster et ProductOwner.
        // Si l'assignee actuel est exclu, on recharge la liste complète pour inclure la sélection existante.
        async function loadMembres(equipeId) {
            if (!equipeId) { reset(assigneeSelect, "-- Aucun --"); return; }
            reset(assigneeSelect, "Chargement...");
            // 1) essayer sans les leads
            const res = await fetch(`/Taches/GetMembresByEquipe?equipeId=${equipeId}&excludeLeads=true`);
            let data = await res.json();
            let containsSelected = data.some(m => String(m.userID) === String(selectedAssignee));

            // 2) si selection existante (édition) et non présente, récupérer la liste complète pour inclure l'assignee
            if (selectedAssignee && !containsSelected) {
                const fullRes = await fetch(`/Taches/GetMembresByEquipe?equipeId=${equipeId}&excludeLeads=false`);
                const fullData = await fullRes.json();
                // fusionner : garder ordre des non-leads puis assurer présence du selected
                const merged = [...data];
                const selectedItem = fullData.find(m => String(m.userID) === String(selectedAssignee));
                if (selectedItem) {
                    // si absent, l'ajouter en tête pour visibilité
                    merged.unshift(selectedItem);
                }
                data = merged;
            }

            assigneeSelect.innerHTML = `<option value="">-- Aucun --</option>`;
            data.forEach(m => {
                assigneeSelect.innerHTML += `<option value="${m.userID}" ${String(m.userID) === String(selectedAssignee) ? "selected" : ""}>${m.nom}</option>`;
            });
            assigneeSelect.disabled = false;
        }

        projectSelect.addEventListener("change", () => {
            loadSprints(projectSelect.value);
            loadEquipes(projectSelect.value);
            reset(assigneeSelect, "-- Choisir une équipe --");
        });

        equipeSelect.addEventListener("change", () => {
            loadMembres(equipeSelect.value);
        });

        // 🔥 Préchargement à l’ouverture
        document.addEventListener("DOMContentLoaded", () => {
            if (projectSelect.value) {
                loadSprints(projectSelect.value);
                loadEquipes(projectSelect.value);
                // si une équipe est déjà sélectionnée (cas postback), déclencher le chargement des membres
                if (equipeSelect.value) {
                    loadMembres(equipeSelect.value);
                }
            }
        });
    </script>


}